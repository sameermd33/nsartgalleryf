<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>NSArt — Orders</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { inter: ['Inter','ui-sans-serif','system-ui'] },
          colors: { brand: { DEFAULT:'#4f46e5' }},
          boxShadow: {
            glow: '0 0 0 1px rgba(255,255,255,0.06), 0 10px 35px rgba(0,0,0,0.25)'
          },
          keyframes: {
            fade: { '0%':{opacity:0, transform:'translateY(6px)'}, '100%':{opacity:1, transform:'translateY(0)'} },
            pop: { '0%':{transform:'scale(.98)', opacity:.7}, '100%':{transform:'scale(1)', opacity:1} }
          },
          animation: { fade:'fade .35s ease both', pop:'pop .18s ease both' }
        }
      }
    }
  </script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{color-scheme: light dark}
    body{ font-family: Inter, ui-sans-serif, system-ui; }
    .glass{ backdrop-filter: blur(10px); background: linear-gradient(140deg, rgba(255,255,255,.7), rgba(255,255,255,.4)); }
    .dark .glass{ background: linear-gradient(140deg, rgba(17,24,39,.7), rgba(17,24,39,.55)); }
    .input{ @apply w-full rounded-2xl border border-gray-200 dark:border-gray-700 bg-white/80 dark:bg-gray-800/60 px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-brand; }
    .btn{ @apply rounded-2xl px-4 py-3 text-sm font-semibold shadow-glow active:scale-[.98] transition; }
    .chip{ @apply inline-flex items-center gap-1 px-2 py-1 text-[11px] rounded-full bg-gray-100 dark:bg-gray-800; }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-50 to-slate-200 dark:from-gray-900 dark:to-gray-800 text-slate-900 dark:text-slate-100">
  <div id="app" class="max-w-md mx-auto p-4 pb-28">

    <!-- LOGIN VIEW -->
    <section id="loginView" class="mt-12 animate-fade">
      <div class="glass rounded-3xl p-6 shadow-glow">
        <div class="flex items-center gap-3 mb-4">
          <div class="h-10 w-10 rounded-2xl bg-brand text-white grid place-content-center font-bold">NS</div>
          <div>
            <h1 class="text-xl font-bold">NSArt — Orders</h1>
            <p class="text-sm text-slate-500 dark:text-slate-400">Secure • Mobile-first dashboard</p>
          </div>
        </div>
        <label class="text-sm font-medium">Password</label>
        <input id="passwordInput" type="password" class="input mt-2" placeholder="Enter password" autocomplete="current-password" />
        <button id="loginBtn" class="btn mt-4 w-full bg-brand text-white">Unlock</button>
        <p id="loginError" class="text-sm text-rose-600 mt-2 hidden">Incorrect password. Try again.</p>
      </div>
    </section>

    <!-- MAIN VIEW -->
    <section id="mainView" class="hidden animate-fade">
      <!-- Header -->
      <div class="sticky top-0 z-20 -mx-4 px-4 pt-3 pb-2 backdrop-blur bg-white/70 dark:bg-gray-900/60">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <div class="h-9 w-9 rounded-2xl bg-brand text-white grid place-content-center font-bold">NS</div>
            <div>
              <h2 class="text-lg font-semibold">My Orders</h2>
              <div class="text-[11px] text-slate-500 dark:text-slate-400">Track new & pending works</div>
            </div>
          </div>
          <button id="addBtn" class="btn bg-brand text-white">+ Add</button>
        </div>
        <div class="mt-3 flex items-center gap-2">
          <input id="searchInput" class="input" placeholder="Search artwork, customer, location" />
        </div>
      </div>

      <!-- Summary chips -->
      <div class="mt-3 flex items-center gap-2 text-xs">
        <span class="chip"><span id="totalCount">0</span> total</span>
        <span class="chip">₹<span id="totalAdvance">0</span> advance</span>
        <span class="chip">₹<span id="totalPending">0</span> pending</span>
      </div>

      <!-- List -->
      <div id="list" class="mt-3 space-y-2"></div>
      <div id="emptyState" class="text-center text-slate-500 dark:text-slate-400 text-sm mt-8 hidden">No items yet. Tap <span class="font-semibold">Add</span> to create your first record.</div>
    </section>

    <!-- BOTTOM BAR -->
    <div id="bottomBar" class="hidden fixed bottom-0 inset-x-0 max-w-md mx-auto p-4">
      <div class="glass rounded-3xl px-4 py-3 shadow-glow flex items-center justify-between">
        <button id="syncBtn" class="btn bg-slate-900 text-white dark:bg-white dark:text-black">Sync</button>
        <div id="statusText" class="text-xs text-slate-700 dark:text-slate-300">Ready</div>
        <button id="addBtn2" class="btn bg-brand text-white">+ Add</button>
      </div>
    </div>

    <!-- ADD MODAL -->
    <dialog id="addModal" class="rounded-3xl w-[92vw] max-w-md border-0 p-0 overflow-hidden backdrop:bg-black/30">
      <div class="glass p-5">
        <div class="flex items-center justify-between mb-2">
          <h3 class="text-base font-semibold">New Artwork</h3>
          <button id="closeModal" class="text-slate-500">✕</button>
        </div>
        <form id="addForm" class="space-y-3">
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="text-xs font-medium">Date</label>
              <input name="date" type="date" class="input mt-1" required />
            </div>
            <div>
              <label class="text-xs font-medium">Expected Delivery</label>
              <input name="expected_delivery_date" type="date" class="input mt-1" required />
            </div>
          </div>
          <div>
            <label class="text-xs font-medium">Location</label>
            <input name="location" type="text" class="input mt-1" placeholder="City/Area" required />
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="text-xs font-medium">Customer Name</label>
              <input name="customer_name" type="text" class="input mt-1" required />
            </div>
            <div>
              <label class="text-xs font-medium">Phone</label>
              <input name="customer_phone" type="tel" pattern="[0-9+\- ]{8,}" class="input mt-1" placeholder="98765 43210" required />
            </div>
          </div>
          <div>
            <label class="text-xs font-medium">Artwork Name</label>
            <input name="artwork_name" type="text" class="input mt-1" placeholder="Portrait / Mural" required />
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="text-xs font-medium">Advance Amount</label>
              <input name="advance_payment" type="number" min="0" step="1" class="input mt-1" required />
            </div>
            <div>
              <label class="text-xs font-medium">Pending Amount</label>
              <input name="pending_payment" type="number" min="0" step="1" class="input mt-1" required />
            </div>
          </div>
          <button class="btn bg-brand text-white w-full mt-2">Save</button>
        </form>
      </div>
    </dialog>

    <!-- TOAST -->
    <div id="toast" class="fixed bottom-24 left-1/2 -translate-x-1/2 px-4 py-2 rounded-2xl bg-black text-white text-sm hidden">Saved</div>
  </div>

  <script>
    /******************** CONFIG ********************/
    // Paste your deployed Apps Script Web App URL below
    const GAS_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzvvlhwFQFspxwCbVya1mv-qkWf6sb15YNN1M2UyVNFDHs3ZNN6myZ_JaXG748IhtdiFw/exec"; // e.g., https://script.google.com/macros/s/AKfycb.../exec
    const PASSWORD = "sunkara"; // fixed password gate and API auth

    /******************** STATE ********************/
    let items = [];

    const qs = (s, el=document) => el.querySelector(s);
    const qsa = (s, el=document) => [...el.querySelectorAll(s)];

    function inr(n){ return Number(n||0).toLocaleString('en-IN'); }

    function toast(text){
      const t = qs('#toast');
      t.textContent = text || 'Saved';
      t.classList.remove('hidden');
      t.classList.add('animate-pop');
      setTimeout(()=>{ t.classList.add('hidden'); t.classList.remove('animate-pop'); }, 1800);
    }

    function saveLocal(){ localStorage.setItem('nsart_items', JSON.stringify(items)); }
    function loadLocal(){ try{ items = JSON.parse(localStorage.getItem('nsart_items')||'[]'); }catch{ items=[]; } }

    function computeSummary(list){
      const total = list.length;
      const adv = list.reduce((a,b)=> a + Number(b.advance_payment||0), 0);
      const pend = list.reduce((a,b)=> a + Number(b.pending_payment||0), 0);
      qs('#totalCount').textContent = total;
      qs('#totalAdvance').textContent = inr(adv);
      qs('#totalPending').textContent = inr(pend);
    }

    function render(){
      const listEl = qs('#list');
      listEl.innerHTML = '';
      const term = (qs('#searchInput').value||'').toLowerCase();
      const filtered = items.filter(r => (
        (r.artwork_name||'').toLowerCase().includes(term) ||
        (r.customer_name||'').toLowerCase().includes(term) ||
        (r.location||'').toLowerCase().includes(term)
      ));

      computeSummary(filtered);
      qs('#emptyState').classList.toggle('hidden', filtered.length!==0);

      filtered.forEach((r) => {
        const card = document.createElement('div');
        card.className = 'glass rounded-3xl p-4 shadow-glow animate-fade';
        card.innerHTML = `
          <div class="flex items-start justify-between">
            <div class="pr-3">
              <div class="text-sm text-slate-500">${escapeHtml(r.date)} • ${escapeHtml(r.location)}</div>
              <div class="mt-0.5 text-base font-semibold">${escapeHtml(r.artwork_name)}</div>
              <div class="mt-1 text-sm"><span class="text-slate-500">Customer:</span> ${escapeHtml(r.customer_name)} <span class="text-slate-500">•</span> ${escapeHtml(r.customer_phone)}</div>
              <div class="mt-1 text-sm"><span class="text-slate-500">Delivery:</span> ${escapeHtml(r.expected_delivery_date)}</div>
            </div>
            <div class="text-right">
              <div class="text-xs text-slate-500">Advance</div>
              <div class="font-semibold">₹${inr(r.advance_payment)}</div>
              <div class="text-xs mt-1 text-slate-500">Pending</div>
              <div class="font-semibold">₹${inr(r.pending_payment)}</div>
            </div>
          </div>
          <div class="mt-3 flex justify-end gap-2">
            <button class="btn bg-rose-600 text-white px-3 py-2" data-id="${r.__id}" data-act="del">Delete</button>
          </div>`;
        listEl.appendChild(card);
      });

      // bind delete
      qsa('[data-act="del"]', listEl).forEach(btn => btn.addEventListener('click', (e)=>{
        const id = e.currentTarget.getAttribute('data-id');
        if(!confirm('Delete this item locally?')) return;
        const idx = items.findIndex(x => x.__id===id);
        if(idx>-1){ items.splice(idx,1); saveLocal(); render(); toast('Deleted locally'); }
      }));
    }

    function escapeHtml(str=''){
      return String(str).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]));
    }

    /******************** GAS BRIDGE ********************/
    async function gasList(){
      if(!GAS_WEB_APP_URL) return {ok:false, error:'Missing GAS URL'};
      try{
        qs('#statusText').textContent = 'Syncing…';
        const res = await fetch(`${GAS_WEB_APP_URL}?auth=${encodeURIComponent(PASSWORD)}`);
        const data = await res.json();
        if(res.ok && data.success && Array.isArray(data.rows)){
          const withIds = data.rows.map(r => ({...r, __id: crypto.randomUUID()}));
          items = withIds;
          saveLocal();
          render();
          qs('#statusText').textContent = 'Synced';
          return {ok:true};
        } else {
          qs('#statusText').textContent = 'Sync error';
          return {ok:false, error:data.error||'Sync error'};
        }
      }catch(err){
        console.warn(err);
        qs('#statusText').textContent = 'Offline';
        return {ok:false, error:String(err)};
      }
    }

    async function gasAppend(record){
      if(!GAS_WEB_APP_URL) return {ok:false, error:'Missing GAS URL'};
      try{
        const res = await fetch(GAS_WEB_APP_URL, {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({ auth: PASSWORD, action:'append', record })
        });
        const data = await res.json();
        return { ok: res.ok && data.success, data };
      }catch(err){ return { ok:false, error:String(err) } }
    }

    /******************** EVENTS ********************/
    window.addEventListener('DOMContentLoaded', () => {
      // Auth gate
      const isAuthed = localStorage.getItem('nsart_auth')==='1';
      if(isAuthed){
        qs('#loginView').classList.add('hidden');
        qs('#mainView').classList.remove('hidden');
        qs('#bottomBar').classList.remove('hidden');
        loadLocal();
        render();
        gasList();
      }

      qs('#loginBtn').addEventListener('click', () => {
        const val = qs('#passwordInput').value.trim();
        if(val===PASSWORD){
          localStorage.setItem('nsart_auth','1');
          qs('#loginError').classList.add('hidden');
          qs('#loginView').classList.add('hidden');
          qs('#mainView').classList.remove('hidden');
          qs('#bottomBar').classList.remove('hidden');
          loadLocal();
          render();
          gasList();
        } else { qs('#loginError').classList.remove('hidden'); }
      });

      qs('#addBtn').addEventListener('click', () => qs('#addModal').showModal());
      qs('#addBtn2').addEventListener('click', () => qs('#addModal').showModal());
      qs('#closeModal').addEventListener('click', () => qs('#addModal').close());
      qs('#searchInput').addEventListener('input', render);
      qs('#syncBtn').addEventListener('click', gasList);

      qs('#addForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const fd = new FormData(e.currentTarget);
        const rec = Object.fromEntries(fd.entries());
        const record = {
          date: rec.date || new Date().toISOString().slice(0,10),
          location: rec.location||'',
          customer_name: rec.customer_name||'',
          customer_phone: rec.customer_phone||'',
          expected_delivery_date: rec.expected_delivery_date||'',
          artwork_name: rec.artwork_name||'',
          advance_payment: rec.advance_payment||'0',
          pending_payment: rec.pending_payment||'0'
        };

        // optimistic UI
        const temp = { ...record, __id: crypto.randomUUID() };
        items.unshift(temp);
        saveLocal();
        render();

        const r = await gasAppend(record);
        if(r.ok){ toast('Saved to Google Sheet'); }
        else { toast('Saved locally (sync failed)'); console.warn(r.error||r.data); }

        e.currentTarget.reset();
        qs('#addModal').close();
      });
    });
  </script>
</body>
</html>
